---
layout: post
title: サーバーアプリとリソースの解放
date: 2023/3/26
---
# はじめに
この記事では、プログラマ向けに、以下の二つの疑問のヒントを提供できればと思い記載しています

 - C# (.NET) でプログラミングする時に使う Dispose メソッドってなに(GC との関係は)
 - C# (.NET) の HttpClient の様に、Disposable なのに不用意に Dispose できないオブジェクトがあるのは何故か？

いろんな方がこの話題を取り挙げているので、内容をご存知の方も多いと思いますが、
本記事では「何故」の部分を少し深掘りしてみたいと思います。

なお、ここでは C# (.NET) を例に説明していますが、他の言語や環境でも全く同じ議論が成立しますので、
普段他の言語を利用している方にも参考になると思います。

# 概念
## GC とリソースの解放

C# や Java をはじめ、Garbage Collection (以降 GC) の機能を備えたプログラミング言語は、
プログラマが自分でオブジェクトの解放しなくて済み、メモリリーク等のバグの発生を低減させてくれる素晴しい機能です。
しかし、確かに GC は便利だけれど、タイミングをプログラマが制御できない点は注意が必要になります。
呼び出すタイミングをプログラマが制御できないという事は、特に共有リソースの解放のタイミイングを制御できない点で問題になる事があります。

### リソースには限りがある

「リソース」とはメモリやネットワーク接続、ファイルディスクリプタなどの OS や PC の資源を指します。
ユーザー一人が PC を占有できるクライアント環境と違い、サーバーの場合は、一つの計算機の資源を複数のスレッド(≒ユーザー)で同時使用しますので、
誰かがリソースを掴んでいると、他の人が使えないという問題が発生しやすい環境です。

例えばあるスレッドが、大きいメモリを確保すると、その分、他のスレッドが利用可能なメモリ領域が減ります。
そして、そのスレッドがメモリを解放するのを怠り、他のスレッドが次々に大きいメモリを連続で確保しようとすると
当然ながら、リソースには限りがありますので、何処かのタイミングでメモリが確保できなくなる可能性があるのはすぐ想像できますね。

### リソースの即時解放が重要

この為、リソースの利用を終えたスレッドは *即時にリソースを解放* して、他のスレッドが再利用できるようにする事がとても重要になります。
GC はいつかはリソースの解放をしてくれますが、タイミングは GC のアルゴリズム次第です。最悪の場合は、そのプロセスが終了するタイミングまでリソースの解放が行なわれないかもしれません。
サーバーアプリケーションの場合は、複数のスレッドがリソースを共有しますので、利用が済んだら直ぐにリソースを解放して、他のスレッドが利用できるようにする必要があります。

### リソースの解放のタイミングを制御できる

ここまで説明すれば結論は見えてますね。
Disposable なオブジェクトは、多くの場合、OS や PC の共有資源を扱うオブジェクトであり、
利用が終了したら即時に Dispose メソッドを呼び出してリソースの即時解放を行なう必要があるオブジェクトです。
Disposable なオブジェクトの Dipspose メソッドを明示的に呼びだして、リソースの解放をタイミングを制御します。

逆に、即時解放は必要がなくて GC での回収を待てるオブジェクトは、敢て Disposable にする必要はありません。

## 




# 実践
# 考察
# (参考) ポート枯渇

